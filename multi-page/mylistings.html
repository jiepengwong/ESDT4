<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Listing</title>
    <!--bootstrap css-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
    <!--axios-->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!--Vue-->
    <script src="https://unpkg.com/vue@next"></script>
    <!-- Google Auth0 -->
    <script async defer src="https://apis.google.com/js/api.js"
        onload="this.onload=function(){};handleClientLoad()"
        onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
    <meta name="google-signin-client_id" content="616186403576-ofsdqf0tp3r19t60rmflus3l3h9p25vo.apps.googleusercontent.com">

</head>
<body>
    <div id="app">
        <!-- Navbar goes here -->
        <navbar></navbar>
        <!-- Header -->
  
        <header class="masthead bg-success p-5">
          <div class="container position-relative">
            <div class="row justify-content-center">
              <div class="col-xl-6">
                <div class="text-center text-white">
                  <!-- Page heading-->
                  <h1 class="mb-5">My Listings</h1>
  
                

                  <div class="row justify-content-center">
                    <div v-for="(key,value) in filters"  class="col-sm-2">

                        <div class="d-flex">
                            <button @click="filterListings(value)" class="btn btn-success p-3">{{key}}</button>
                        </div>
                     
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </header>
  
  
        <section id="listings">
  
          <div class="container">
            <div class="row">
              <div class="col-lg-12">
                <h2 class="mb-5 py-5">Listings</h2>
              </div>
            </div>
            <div class="row">
              <div v-for="result in results" :key="result" class="col-lg-4 col-md-6 mb-4">
                <div class="card h-100">
                  <a href="#"><img class="card-img-top" src="http://placehold.it/700x400" alt="" /></a>
                  <div class="card-body">
                    <h4 class="card-title">
                      <a href="#">{{result.item_name}}</a>
                    </h4>
                    <p class="card-text">{{result.description}}</p>
                    
                    <button v-if="result.item_status == 'open'"e class="btn btn-danger" @click="removeListing(result._id)">Remove</button>

                    <button v-if="result.item_status == 'pending'" class="btn btn-success" @click="acceptOffer(result._id)">Accept</button>
                    <button v-if="result.item_status == 'pending'" class="btn btn-danger mx-2" @click="rejectOffer(result._id)">Reject</button>


                  </div>
                  <div class="card-footer">
                    <small class="text-muted">Item status: {{result.item_status}}</small>
                  </div>
                </div>
              </div>

              {{localStorageData}}
  
          </div>
  
  
        </section>
  
  
      </div>
    
</body>
</html>


<script src="./narbar.js"></script>
<script>
    const app = Vue.createApp({
    data() {
      return {
          filters: { "All": "All Listings", "open": "My Listings (Open)", "pending": "Incoming Offers (Pending)", "accepted": "Awaiting Collection (Accepted)", "closed": "Reviews (Closed)"},
          localStorageData: localStorage.id, //this is from oauth, for now put some dummy data
          results: [],
          unfilteredResult: '',
          filteredTabResults: []

     
      };
    },
    async mounted() {

      this.checkLogin();
      // Fetching from NEW items microservice
      try{
        //   this.localStorageData = localStorage.getItem("user_id"); -> When it is actually implemented try this

          var getItemUrl = `http://localhost:5001/items/mylistings/seller/${this.localStorageData}`;
          
          var databaseitems = await fetch(getItemUrl)
          const databaseitemsJson = await databaseitems.json()

          if (databaseitems.status === 200){
            console.log(databaseitemsJson)
            // Get all the databases 
            this.results = databaseitemsJson.Success;
            this.unfilteredResult = databaseitemsJson.Success;
            console.log(this.results)

          }
          else{
           
          }
          }

          catch(error) {
            console.log(error)
          }
    },

    methods:{
      checkLogin() {
                // If the login variable is initalised, then we will redirect them to 
            if (localStorage.getItem("id")){
                // redirect them to login page
                // window.location.replace("/ESD_PROJECT/ESDT4/multi-page/catalogue.php");
            }
            else {
                window.location.replace("./index.html");
            }
                }, 


      filterListings(categoryName){
        console.log("hi")
        this.resetPosts()
        console.log(categoryName)
        console.log(this.results)
        if (categoryName !== "All"){

          this.results = this.results.filter((result) => {
            // console.log(result.Category)
            return result.item_status === categoryName;
          })
        }

      },

      resetPosts(){
        this.results = this.unfilteredResult
      },

      acceptOffer(itemid){

        // Fetch post ID TO COMPLEX
          console.log("hi")
          console.log(itemid)
          const payload = {
            item_id: itemid
          }

      },

      rejectOffer(itemid){

      // Fetch post ID TO COMPLEX
        console.log("hi")
        console.log(itemid)
        const payload = {
            item_id: itemid
          }

      },
      removeListing(itemid){
                  console.log("hi")
                  console.log(itemid)
                  var deleteItemUrl = `http://localhost:5001/items/delete/${itemid}`;
                  const options = {
                    method: 'DELETE',
                    headers: {
                      'Content-Type': 'application/json'
                    }
                  }
                  fetch(deleteItemUrl, options)
                  .then(response => {
                    if (response.status === 200) {
                      alert("Item has been removed!")
                      location.reload()
                    }
                    else {
                      alert("Item could not be removed!")
                    }
                  })


                }
    },

    computed:{
    
    }
  });

  app.component("navbar",{
            template: template1,
            data() {
                return{
                    links: links1,
                    isSignedIn: localStorage.getItem("id"),
                }

            },

            methods:{
                
                signOut() {
                    let gapi = window.gapi;
                    let clientId ="616186403576-ofsdqf0tp3r19t60rmflus3l3h9p25vo.apps.googleusercontent.com";
                    let apiKey ="AIzaSyC0WtHoYqLnGKgaqLWX6RGkiL0X2C7dll8";
                    let secretClientId = "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";
                    let discoveryDocs =["https://www.googleapis.com/discovery/v1/apis/oauth2/v2/rest"];
                    let scope ="https://www.googleapis.com/auth/userinfo.profile";

                    gapi.load("client:auth2", () => {
                        gapi.client.init({
                            apiKey,
                            clientId,
                            discoveryDocs,
                            scope,
                            secretClientId,})

                            .then(() => {
                                var GoogleAuthObj = gapi.auth2.getAuthInstance();
                                this.GoogleAuth = GoogleAuthObj.signOut();
                                this.isSignedIn = false;
                            })
                    })
                    
                    localStorage.removeItem("login")
                    localStorage.removeItem("id")
                    alert("You have been logged out!")
                    location.reload()
                },
            }
        })

 app.component("navbar",{
            template: template1,
            data() {
                return{
                    links: links1,
                    isSignedIn: localStorage.getItem("id"),
                }

            },

            methods:{
                
                signOut() {
                    let gapi = window.gapi;
                    let clientId ="616186403576-ofsdqf0tp3r19t60rmflus3l3h9p25vo.apps.googleusercontent.com";
                    let apiKey ="AIzaSyC0WtHoYqLnGKgaqLWX6RGkiL0X2C7dll8";
                    let secretClientId = "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";
                    let discoveryDocs =["https://www.googleapis.com/discovery/v1/apis/oauth2/v2/rest"];
                    let scope ="https://www.googleapis.com/auth/userinfo.profile";

                    gapi.load("client:auth2", () => {
                        gapi.client.init({
                            apiKey,
                            clientId,
                            discoveryDocs,
                            scope,
                            secretClientId,})

                            .then(() => {
                                var GoogleAuthObj = gapi.auth2.getAuthInstance();
                                this.GoogleAuth = GoogleAuthObj.signOut();
                                this.isSignedIn = false;
                            })
                    })
                    
                    localStorage.removeItem("login")
                    localStorage.removeItem("id")
                    alert("You have been logged out!")
                    location.reload()
        },
            }
        })

  app.mount("#app");

</script>



<style>

</style>